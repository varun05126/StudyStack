{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="page-title">
    <h2>âž• Add Smart Task</h2>
    <p>Upload study material or create a task manually. The system will help estimate difficulty.</p>
</div>

<div class="card form-card">

<form method="POST" enctype="multipart/form-data" id="taskForm">
{% csrf_token %}

<!-- TITLE -->
<div class="form-group">
    <label>Title</label>
    {{ form.title }}
</div>

<!-- SUBJECT -->
<div class="form-group">
    <label>Select Existing Subject</label>
    {{ form.subject }}
</div>

<div class="form-group">
    <label>Or Create New Subject</label>
    <input type="text" name="new_subject" class="input" placeholder="e.g. Engineering Chemistry">
</div>

<!-- FILE -->
<div class="form-group">
    <label>Upload Study Material (PDF / TXT / DOCX)</label>
    <input type="file" name="study_file" id="studyFile" class="input" accept=".pdf,.txt,.docx">
    <small class="hint">Uploading a file enables smart difficulty estimation.</small>
</div>

<hr class="soft-line">

<!-- AUTO ESTIMATION BOX -->
<div id="autoBox" class="auto-box" style="display:none;">
    <h4>ðŸ¤– Smart Analysis</h4>
    <p id="autoStatus">Reading document...</p>

    <div class="estimate-result">
        <strong>Estimated Difficulty:</strong>
        <span id="estimatedLevel">Processing...</span>
    </div>

    <p class="confirm-text">
        Do you want to keep this difficulty or change it manually?
    </p>
</div>

<!-- DIFFICULTY -->
<div class="form-group">
    <label>Difficulty (Confirm or change)</label>
    {{ form.difficulty }}
</div>

<!-- HOURS -->
<div class="form-group">
    <label>Estimated Hours</label>
    {{ form.estimated_hours }}
</div>

<!-- DEADLINE -->
<div class="form-group">
    <label>Deadline</label>
    {{ form.deadline }}
</div>

<!-- NOTES -->
<div class="form-group">
    <label>Notes</label>
    {{ form.notes }}
</div>

<button type="submit" class="btn-primary">Create Smart Task</button>

</form>
</div>

<!-- ================= SMART FRONTEND LOGIC ================= -->

<script>
const fileInput = document.getElementById("studyFile");
const autoBox = document.getElementById("autoBox");
const autoStatus = document.getElementById("autoStatus");
const estimatedLevel = document.getElementById("estimatedLevel");
const difficultySelect = document.getElementById("id_difficulty");

fileInput.addEventListener("change", function () {
    if (this.files.length > 0) {
        autoBox.style.display = "block";
        autoStatus.innerText = "Analyzing document...";
        estimatedLevel.innerText = "Please wait...";

        // Fake smart delay (backend will replace this)
        setTimeout(() => {
            let levels = ["Easy", "Medium", "Hard"];
            let picked = levels[Math.floor(Math.random() * levels.length)];

            autoStatus.innerText = "Analysis complete.";
            estimatedLevel.innerText = picked;

            // Auto-set difficulty dropdown
            for (let i = 0; i < difficultySelect.options.length; i++) {
                if (difficultySelect.options[i].text === picked) {
                    difficultySelect.selectedIndex = i;
                }
            }

        }, 1200);
    } else {
        autoBox.style.display = "none";
    }
});
</script>

<!-- ================= STYLES ================= -->

<style>
.auto-box {
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    padding: 18px;
    margin: 18px 0;
}

.auto-box h4 {
    margin-bottom: 6px;
    color: #4f46e5;
}

.estimate-result {
    margin-top: 8px;
    font-size: 1.05rem;
}

.confirm-text {
    margin-top: 6px;
    font-size: 0.9rem;
    color: #555;
}

.soft-line {
    border: none;
    height: 1px;
    background: #eee;
    margin: 20px 0;
}
</style>

{% endblock %}
